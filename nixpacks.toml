# Configuración de Nixpacks para Railway
# Este archivo se usa cuando Railway tiene el Root Directory configurado como "." (raíz)
# IMPORTANTE: Cambia el Root Directory en Railway de "backend" a "." (o vacío)

[phases.setup]
nixPkgs = ["python311", "python311Packages.pip", "git-lfs"]

[phases.install]
dependsOn = ["setup"]
cmds = [
    "# Instalar Git LFS",
    "git lfs install || echo 'Git LFS ya instalado o no disponible'",
    "# Descargar archivos LFS desde la raíz del repositorio",
    "git lfs pull || echo 'Git LFS pull falló o no hay archivos LFS'",
    "# Verificar que los archivos LFS se descargaron correctamente (no son solo punteros)",
    "if [ -f dataset/best_model.pth ]; then",
    "  SIZE=$(stat -f%z dataset/best_model.pth 2>/dev/null || stat -c%s dataset/best_model.pth 2>/dev/null || echo 0)",
    "  echo \"dataset/best_model.pth tamaño: $SIZE bytes\"",
    "  if [ \"$SIZE\" -lt 1024 ]; then",
    "    echo 'ADVERTENCIA: dataset/best_model.pth es muy pequeño, puede ser un puntero LFS. Intentando git lfs pull específico...'",
    "    git lfs pull --include='dataset/best_model.pth' || git lfs pull --include='*.pth' || true",
    "  fi",
    "fi",
    "if [ -f best_model.pth ]; then",
    "  SIZE=$(stat -f%z best_model.pth 2>/dev/null || stat -c%s best_model.pth 2>/dev/null || echo 0)",
    "  echo \"best_model.pth tamaño: $SIZE bytes\"",
    "  if [ \"$SIZE\" -lt 1024 ]; then",
    "    echo 'ADVERTENCIA: best_model.pth es muy pequeño, puede ser un puntero LFS. Intentando git lfs pull específico...'",
    "    git lfs pull --include='best_model.pth' || git lfs pull --include='*.pth' || true",
    "  fi",
    "fi",
    "# Instalar dependencias Python del backend",
    "pip3 install --no-cache-dir -r backend/requirements.txt"
]

[phases.build]
dependsOn = ["install"]
cmds = [
    "echo 'Backend build complete'",
    "# Verificar que los archivos necesarios estén disponibles",
    "ls -la dataset/best_model.pth || ls -la best_model.pth || echo 'Verificando best_model.pth...'",
    "ls -la classes.json || echo 'Verificando classes.json...'",
    "# Copiar archivos al backend para que estén disponibles",
    "mkdir -p backend/dataset || true",
    "cp classes.json backend/classes.json 2>/dev/null || echo 'classes.json no encontrado, usando copia en backend/'",
    "# Copiar best_model.pth a backend/ para que esté disponible cuando el código lo busque",
    "cp dataset/best_model.pth backend/best_model.pth 2>/dev/null || cp best_model.pth backend/best_model.pth 2>/dev/null || echo 'best_model.pth no encontrado en raíz, verificando backend/...'",
    "cp dataset/best_model.pth backend/dataset/best_model.pth 2>/dev/null || echo 'Intentando copiar a backend/dataset/...'",
    "# Verificar que se copió correctamente",
    "ls -la backend/best_model.pth || ls -la backend/dataset/best_model.pth || echo 'best_model.pth no está en backend/, el código lo buscará en otras ubicaciones'"
]

[start]
cmd = "cd backend && uvicorn api:app --host 0.0.0.0 --port ${PORT:-8000}"

