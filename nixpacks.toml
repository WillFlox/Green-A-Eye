# Configuración de Nixpacks para Railway
# Este archivo se usa cuando Railway tiene el Root Directory configurado como "." (raíz)
# IMPORTANTE: Cambia el Root Directory en Railway de "backend" a "." (o vacío)

[phases.setup]
nixPkgs = ["python311", "python311Packages.pip", "git-lfs", "curl"]

[phases.install]
dependsOn = ["setup"]
cmds = [
    "# Instalar Git LFS",
    "git lfs install || echo 'Git LFS ya instalado o no disponible'",
    "# NOTA: git lfs pull puede fallar si no hay repositorio Git en Railway build",
    "# Los archivos LFS deberían descargarse automáticamente durante el clone",
    "# Intentar git lfs pull solo si hay repositorio Git",
    "(git lfs pull 2>/dev/null || echo 'Git LFS pull no disponible en build, archivos deberían estar disponibles desde clone')",
    "# Verificar que los archivos LFS están disponibles (no son solo punteros)",
    "if [ -f dataset/best_model.pth ]; then SIZE=$(stat -f%z dataset/best_model.pth 2>/dev/null || stat -c%s dataset/best_model.pth 2>/dev/null || echo 0); echo \"dataset/best_model.pth tamaño: $SIZE bytes\"; if [ \"$SIZE\" -lt 1024 ]; then echo 'ADVERTENCIA: dataset/best_model.pth es muy pequeño ($SIZE bytes), puede ser un puntero LFS'; fi; fi",
    "if [ -f best_model.pth ]; then SIZE=$(stat -f%z best_model.pth 2>/dev/null || stat -c%s best_model.pth 2>/dev/null || echo 0); echo \"best_model.pth tamaño: $SIZE bytes\"; if [ \"$SIZE\" -lt 1024 ]; then echo 'ADVERTENCIA: best_model.pth es muy pequeño ($SIZE bytes), puede ser un puntero LFS'; fi; fi",
    "# Instalar dependencias Python del backend",
    "# Usar pip con --break-system-packages para Nix (o crear venv si es posible)",
    "python3 -m pip install --no-cache-dir --break-system-packages -r backend/requirements.txt || pip install --no-cache-dir --break-system-packages -r backend/requirements.txt"
]

[phases.build]
dependsOn = ["install"]
cmds = [
    "echo 'Backend build complete'",
    "# Descargar siempre el modelo desde GitHub para evitar problemas con Git LFS en Railway",
    "mkdir -p dataset",
    "echo 'Descargando best_model.pth desde GitHub...'",
    "curl -L https://raw.githubusercontent.com/WillFlox/Green-A-Eye/main/best_model.pth -o dataset/best_model.pth",
    "# Verificar que el modelo se descargó correctamente",
    "ls -lh dataset/best_model.pth || echo 'ERROR: No se pudo descargar dataset/best_model.pth'",
    "ls -la classes.json || echo 'Verificando classes.json...'",
    "# Copiar archivos al backend para que estén disponibles",
    "mkdir -p backend/dataset || true",
    "cp classes.json backend/classes.json 2>/dev/null || echo 'classes.json no encontrado, usando copia en backend/'",
    "cp dataset/best_model.pth backend/best_model.pth 2>/dev/null || echo 'best_model.pth no encontrado en dataset/'",
    "cp dataset/best_model.pth backend/dataset/best_model.pth 2>/dev/null || echo 'Intentando copiar a backend/dataset/...'",
    "# Verificar que se copió correctamente",
    "ls -la backend/best_model.pth || ls -la backend/dataset/best_model.pth || echo 'best_model.pth no está en backend/, el código lo buscará en otras ubicaciones'"
]

[start]
cmd = "cd backend && uvicorn api:app --host 0.0.0.0 --port ${PORT:-8000}"

