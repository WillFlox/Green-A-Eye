# Configuración de Nixpacks para Railway - Backend
# Este archivo se usa cuando Railway tiene el Root Directory configurado como "backend"
# IMPORTANTE: Railway ya está en el directorio backend, no hace falta hacer "cd backend"

[phases.setup]
nixPkgs = ["python311", "python311Packages.pip", "git-lfs"]

[phases.install]
dependsOn = ["setup"]
cmds = [
    "# Instalar Git LFS",
    "git lfs install || echo 'Git LFS ya instalado o no disponible'",
    "# NOTA: git lfs pull puede fallar si no hay repositorio Git en Railway build",
    "# Los archivos LFS deberían descargarse automáticamente durante el clone",
    "# Intentar git lfs pull solo si hay repositorio Git",
    "(cd .. && git lfs pull 2>/dev/null || echo 'Git LFS pull no disponible en build, archivos deberían estar disponibles desde clone') && cd backend || cd .",
    "(git lfs pull 2>/dev/null || echo 'Git LFS pull no disponible desde directorio actual')",
    "# Verificar que el archivo LFS está disponible (no es solo un puntero)",
    "if [ -f ../dataset/best_model.pth ]; then SIZE=$(stat -f%z ../dataset/best_model.pth 2>/dev/null || stat -c%s ../dataset/best_model.pth 2>/dev/null || echo 0); echo \"../dataset/best_model.pth tamaño: $SIZE bytes\"; if [ \"$SIZE\" -lt 1024 ]; then echo 'ADVERTENCIA: ../dataset/best_model.pth es muy pequeño ($SIZE bytes), puede ser un puntero LFS'; fi; fi",
    "if [ -f ../best_model.pth ]; then SIZE=$(stat -f%z ../best_model.pth 2>/dev/null || stat -c%s ../best_model.pth 2>/dev/null || echo 0); echo \"../best_model.pth tamaño: $SIZE bytes\"; if [ \"$SIZE\" -lt 1024 ]; then echo 'ADVERTENCIA: ../best_model.pth es muy pequeño ($SIZE bytes), puede ser un puntero LFS'; fi; fi",
    "# Instalar dependencias Python del backend",
    "# Usar pip con --break-system-packages para Nix (o crear venv si es posible)",
    "python3 -m pip install --no-cache-dir --break-system-packages -r requirements.txt || pip install --no-cache-dir --break-system-packages -r requirements.txt"
]

[phases.build]
dependsOn = ["install"]
cmds = [
    "echo 'Backend build complete'",
    "# Intentar copiar archivos necesarios desde el directorio padre si están disponibles",
    "# NOTA: En Railway con Root Directory = backend, puede que no haya acceso al directorio padre",
    "cp ../classes.json classes.json 2>/dev/null || echo 'classes.json no encontrado en parent, usando copia local'",
    "mkdir -p dataset || true",
    "# Copiar best_model.pth desde diferentes ubicaciones posibles y verificar que NO es un puntero LFS",
    "if [ -f ../dataset/best_model.pth ]; then SIZE=$(stat -f%z ../dataset/best_model.pth 2>/dev/null || stat -c%s ../dataset/best_model.pth 2>/dev/null || echo 0); if [ \"$SIZE\" -gt 1024 ]; then cp ../dataset/best_model.pth best_model.pth && echo 'best_model.pth copiado desde ../dataset/'; else echo 'ERROR: ../dataset/best_model.pth parece ser un puntero LFS, no el archivo real. Ejecuta: git lfs pull'; fi; elif [ -f ../best_model.pth ]; then SIZE=$(stat -f%z ../best_model.pth 2>/dev/null || stat -c%s ../best_model.pth 2>/dev/null || echo 0); if [ \"$SIZE\" -gt 1024 ]; then cp ../best_model.pth best_model.pth && echo 'best_model.pth copiado desde ../'; else echo 'ERROR: ../best_model.pth parece ser un puntero LFS, no el archivo real'; fi; else echo 'best_model.pth no encontrado en parent, el código lo buscará en runtime'; fi",
    "# Verificar que best_model.pth existe y tiene tamaño correcto",
    "if [ -f best_model.pth ]; then SIZE=$(stat -f%z best_model.pth 2>/dev/null || stat -c%s best_model.pth 2>/dev/null || echo 0); echo \"best_model.pth encontrado con tamaño: $SIZE bytes\"; if [ \"$SIZE\" -lt 1024 ]; then echo 'ADVERTENCIA: best_model.pth es muy pequeño, puede ser un puntero LFS'; fi; fi",
    "ls -lh best_model.pth 2>/dev/null || echo 'best_model.pth no está en backend/'"
]

[start]
cmd = "uvicorn api:app --host 0.0.0.0 --port ${PORT:-8000}"

